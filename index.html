<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobilidade Pro - Filtros Inteligentes</title>
    <style>
        :root {
            --primary: #4361ee;
            --whatsapp: #25d366;
            --bg: #f4f7fe;
            --card: #ffffff;
            --text: #212529;
            --border: #e2e8f0;
            --muted: #64748b;
            --accent: #4361ee15;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0f172a;
                --card: #1e293b;
                --text: #f8fafc;
                --border: #334155;
                --muted: #94a3b8;
                --accent: #4361ee30;
            }
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0; padding: 15px;
            transition: all 0.3s ease;
        }

        .container { max-width: 900px; margin: 0 auto; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h2 { font-size: 1.4rem; margin: 0; }

        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            position: relative;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: var(--card); border: 1px solid var(--border);
            padding: 10px 18px; border-radius: 25px; font-size: 0.85rem;
            cursor: pointer; color: var(--text); white-space: nowrap; transition: 0.2s;
            display: flex; align-items: center; gap: 5px;
        }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .dropdown-content {
            display: none;
            position: absolute;
            top: 45px;
            left: 0;
            background: var(--card);
            min-width: 220px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-radius: 12px;
            border: 1px solid var(--border);
            z-index: 100;
            max-height: 250px;
            overflow-y: auto;
            padding: 8px;
        }
        .dropdown-content.show { display: block; animation: fadeIn 0.2s ease; }

        .dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            border-radius: 8px;
            transition: 0.2s;
            font-size: 0.9rem;
            color: var(--text);
        }
        .dropdown-item:hover { background: var(--accent); color: var(--primary); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .search-box input {
            width: 100%; padding: 16px; border: 1px solid var(--border); border-radius: 14px;
            background: var(--card); color: var(--text); font-size: 16px; outline: none;
            box-sizing: border-box; margin-bottom: 20px;
        }

        .table-wrapper { background: var(--card); border-radius: 18px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { background: var(--accent); padding: 18px; text-align: left; font-size: 0.7rem; color: var(--muted); text-transform: uppercase; }
        td { padding: 18px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }

        .btn-share {
            background: var(--whatsapp); color: white; border: none;
            padding: 8px 12px; border-radius: 8px; cursor: pointer;
            font-size: 0.8rem; display: flex; align-items: center; gap: 5px;
            text-decoration: none; width: fit-content;
        }

        @media (max-width: 650px) {
            table { min-width: 100%; }
            table thead { display: none; }
            tr { display: block; padding: 20px; border-bottom: 8px solid var(--bg); }
            td { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border: none; }
            td::before { content: attr(data-label); font-weight: 600; color: var(--muted); font-size: 0.75rem; text-transform: uppercase; }
        }

        .skeleton { height: 15px; background: var(--border); border-radius: 10px; position: relative; overflow: hidden; margin-bottom: 10px; }
        .skeleton::after {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: loading 1.5s infinite;
        }
        @keyframes loading { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>üöå Itiner√°rios</h2>
        <div id="relogio" style="font-size: 0.9rem; opacity: 0.7;">00:00:00</div>
    </div>

    <div class="search-box">
        <input type="text" id="search" placeholder="Para onde vamos?">
    </div>

    <div class="filter-controls">
        <button class="filter-btn active" id="btnLimpar" onclick="limparFiltros()">Limpar</button>

        <div style="position: relative;">
            <button class="filter-btn" id="btnFiltroBairro" onclick="toggleDropdown('dropBairro')">üìç Bairro ‚ñæ</button>
            <div id="dropBairro" class="dropdown-content"></div>
        </div>

        <div style="position: relative;">
            <button class="filter-btn" id="btnFiltroLinha" onclick="toggleDropdown('dropLinha')">üî¢ Linha ‚ñæ</button>
            <div id="dropLinha" class="dropdown-content"></div>
        </div>
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
            <tr>
                <th>Bairro</th>
                <th>Ponto de Passagem</th>
                <th>Parada</th>
                <th>Linha</th>
                <th>Tipo de Viagem</th>
                <th>A√ß√£o</th>
            </tr>
            </thead>
            <tbody id="tableBody">
            <tr><td colspan="6"><div class="skeleton"></div></td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    let pontos = [];
    let filtroAtivo = { bairro: null, linha: null };

    setInterval(() => {
        document.getElementById('relogio').innerText = new Date().toLocaleTimeString('pt-br');
    }, 1000);

    function toggleDropdown(id) {
        document.querySelectorAll('.dropdown-content').forEach(d => {
            if (d.id !== id) d.classList.remove('show');
        });
        document.getElementById(id).classList.toggle("show");
    }

    window.onclick = function(event) {
        if (!event.target.closest('.filter-controls')) {
            document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show'));
        }
    }

    async function carregarCSV() {
        try {
            const response = await fetch('pontos.csv');
            const data = await response.text();
            const linhasCSV = data.split(/\r?\n/).filter(l => l.trim() !== "");

            pontos = linhasCSV.slice(1).map(linha => {
                const col = linha.split(',');
                return {
                    bairro: col[0]?.trim() || '-',
                    ponto: col[1]?.trim() || '-',
                    parada: col[2]?.trim() || '-',
                    linha: col[3]?.trim() || '-',
                    tipo: col[4]?.trim() || '-'
                };
            });

            atualizarMenus();
            aplicarFiltros();
        } catch (e) { tableBody.innerHTML = "<tr><td colspan='6'>Erro ao carregar dados.</td></tr>"; }
    }

    // NOVA FUN√á√ÉO: Atualiza os dropdowns baseada no que est√° filtrado
    function atualizarMenus() {
        // Dropdown de Bairros: Sempre mostra todos os bairros dispon√≠veis no CSV
        const bairrosDisponiveis = [...new Set(pontos.map(p => p.bairro))].sort();
        document.getElementById('dropBairro').innerHTML = bairrosDisponiveis.map(b => `
            <div class="dropdown-item" onclick="setFiltro('bairro', '${b}')">${b}</div>
        `).join('');

        // Dropdown de Linhas: Depende do bairro selecionado!
        let linhasParaMostrar = pontos;
        if (filtroAtivo.bairro) {
            linhasParaMostrar = pontos.filter(p => p.bairro === filtroAtivo.bairro);
        }

        const linhasUnicas = [...new Set(linhasParaMostrar.map(p => p.linha))].sort();

        document.getElementById('dropLinha').innerHTML = linhasUnicas.map(l => `
            <div class="dropdown-item" onclick="setFiltro('linha', '${l}')">${l}</div>
        `).join('');
    }

    function setFiltro(tipo, valor) {
        filtroAtivo[tipo] = valor;

        const btn = tipo === 'bairro' ? 'btnFiltroBairro' : 'btnFiltroLinha';
        const icon = tipo === 'bairro' ? 'üìç' : 'üî¢';
        document.getElementById(btn).innerHTML = `${icon} ${valor} ‚ñæ`;
        document.getElementById(btn).classList.add('active');
        document.getElementById('btnLimpar').classList.remove('active');

        // Se mudar o bairro, reseta a linha selecionada para evitar conflitos
        if (tipo === 'bairro') {
            filtroAtivo.linha = null;
            document.getElementById('btnFiltroLinha').innerHTML = `üî¢ Linha ‚ñæ`;
            document.getElementById('btnFiltroLinha').classList.remove('active');
        }

        document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show'));

        atualizarMenus(); // Rebuild dos menus com as novas op√ß√µes
        aplicarFiltros();
    }

    function aplicarFiltros() {
        let resultado = pontos;
        if (filtroAtivo.bairro) resultado = resultado.filter(p => p.bairro === filtroAtivo.bairro);
        if (filtroAtivo.linha) resultado = resultado.filter(p => p.linha === filtroAtivo.linha);
        mostrarTabela(resultado);
    }

    function limparFiltros() {
        filtroAtivo = { bairro: null, linha: null };
        document.getElementById('btnFiltroBairro').innerHTML = `üìç Bairro ‚ñæ`;
        document.getElementById('btnFiltroBairro').classList.remove('active');
        document.getElementById('btnFiltroLinha').innerHTML = `üî¢ Linha ‚ñæ`;
        document.getElementById('btnFiltroLinha').classList.remove('active');
        document.getElementById('btnLimpar').classList.add('active');
        atualizarMenus();
        mostrarTabela(pontos);
    }

    function compartilhar(bairro, ponto, parada, linha, tipo) {
        const mensagem = `üöå *Itiner√°rio*%0A*Bairro:* ${bairro}%0A*Linha:* ${linha}%0A*Ponto:* ${ponto}`;
        window.open(`https://api.whatsapp.com/send?text=${mensagem}`, '_blank');
    }

    function mostrarTabela(lista) {
        tableBody.innerHTML = lista.map(p => `
            <tr>
                <td data-label="Bairro"><strong>${p.bairro}</strong></td>
                <td data-label="Ponto de Passagem">${p.ponto}</td>
                <td data-label="Parada">${p.parada}</td>
                <td data-label="Linha">${p.linha}</td>
                <td data-label="Tipo de Viagem">${p.tipo}</td>
                <td data-label="A√ß√£o"><button class="btn-share" onclick="compartilhar('${p.bairro}', '${p.ponto}', '${p.parada}', '${p.linha}', '${p.tipo}')">üì≤ Zap</button></td>
            </tr>
        `).join('');
    }

    document.getElementById("search").addEventListener("input", (e) => {
        const v = e.target.value.toLowerCase();
        const f = pontos.filter(p => Object.values(p).some(val => val && val.toLowerCase().includes(v)));
        mostrarTabela(f);
    });

    carregarCSV();
</script>
</body>
</html>
